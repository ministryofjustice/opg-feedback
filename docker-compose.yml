version: "3.7"

services:
  postgres:
    image: postgres:10.13
    ports:
      - 5432:5432
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: lpadb
      POSTGRES_USER: lpauser
      POSTGRES_PASSWORD: lpapass
    healthcheck:
      test: ["CMD-SHELL", "pg_isready --username=lpauser --dbname=lpadb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------
  # Create feedback table and db user for PerfPlat
  feedbackdb:
    image: feedbackdb
    build:
      context: ./
      dockerfile: feedbackdb/docker/app/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      OPG_LPA_STACK_NAME: "local"
      OPG_LPA_STACK_ENVIRONMENT: "dev"
      OPG_LPA_POSTGRES_HOSTNAME: "postgres"
      OPG_LPA_POSTGRES_PORT: "5432"
      OPG_LPA_POSTGRES_NAME: "lpadb"
      OPG_LPA_POSTGRES_USERNAME: "lpauser"
      OPG_LPA_POSTGRES_PASSWORD: "lpapass"
      OPG_LPA_POSTGRES_FEEDBACK_USERNAME: "feedbackuser"
      OPG_LPA_POSTGRES_FEEDBACK_PASSWORD: "feedbackpass"

  feedback-rest-api:
    container_name: feedback-rest-api
    image: feedback-rest-api
    build:
      context: ./
      dockerfile: ./feedbackapi/docker/app/Dockerfile
    depends_on:
      - postgres
      - feedbackdb
    environment:
      AWS_XRAY_SDK_ENABLED: "false"
      POSTGRES_HOSTNAME: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_NAME: "lpadb"
      POSTGRES_USERNAME: "lpauser"
      POSTGRES_PASSWORD: "lpapass"
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN}
      AWS_SECURITY_TOKEN: ${AWS_SECURITY_TOKEN}
    ports:
      - 9004:8005
